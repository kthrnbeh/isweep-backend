<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISweep Test - HTML5 Video</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        header h1 {
            color: #667eea;
            margin-bottom: 8px;
        }
        header p {
            color: #666;
            font-size: 14px;
        }
        .test-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 20px;
        }
        .instructions {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        .instructions ol {
            margin-left: 20px;
        }
        .instructions li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
        video {
            width: 100%;
            max-width: 800px;
            border: 3px solid #667eea;
            border-radius: 8px;
            margin-bottom: 20px;
            background: black;
        }
        .status-box {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 13px;
        }
        .status-box strong {
            color: #667eea;
        }
        code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .warning {
            background: #fffbea;
            border-left: 4px solid #f39c12;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .success {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        footer {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            color: #666;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>üé¨ ISweep Test Suite</h1>
            <p>Testing HTML5 Video Filtering with Captions</p>
        </header>

        <!-- HTML5 Video Test -->
        <div class="test-section">
            <h2>Test 1: HTML5 Video Filtering</h2>
            
            <div class="instructions">
                <strong>Setup Instructions:</strong>
                <ol>
                    <li>Click ISweep icon in top-right ‚Üí <strong>‚öôÔ∏è Preferences</strong></li>
                    <li>Under <strong>Language</strong> category, add blocked word: <code>profanity</code></li>
                    <li>Click <strong>Save Settings</strong></li>
                    <li>Return to this page and click ISweep icon ‚Üí <strong>Enable ISweep</strong></li>
                    <li>Play the video below</li>
                    <li>When "profanity" appears in captions ‚Üí video should <strong>MUTE</strong></li>
                </ol>
            </div>

            <strong>Video with Captions:</strong>
            <video id="testVideo" controls crossorigin="anonymous" style="width: 100%; max-width: 900px;">
                <!-- Prefer local test.mp4; JS will fall back to remote if missing -->
                <source id="videoSource" src="test.mp4" type="video/mp4" />

                <!-- Captions MUST be in same folder as this HTML if using a relative path -->
                <track
                    kind="captions"
                    src="captions.vtt"
                    srclang="en"
                    label="English"
                    default
                />

                Sorry, your browser does not support embedded videos.
            </video>

            <p id="captionStatus" style="font-family: sans-serif;"></p>
            <script>
                const v = document.getElementById("testVideo");
                const status = document.getElementById("captionStatus");
                const source = document.getElementById("videoSource");
                const fallbackSrc = "https://www.w3schools.com/html/mov_bbb.mp4";

                function updateStatus() {
                    const tracks = v.textTracks;
                    if (!tracks || tracks.length === 0) {
                        status.textContent = "Captions: no textTracks found (track may not have loaded).";
                        return;
                    }
                    status.textContent = `Captions: loaded (${tracks.length} track), mode=${tracks[0].mode}`;
                }

                // Prefer local test.mp4; if missing, fall back to remote sample
                fetch("test.mp4", { method: "HEAD" })
                    .then((r) => {
                        if (!r.ok) throw new Error("local test.mp4 missing");
                        v.load();
                    })
                    .catch(() => {
                        source.src = fallbackSrc;
                        v.load();
                    });

                v.addEventListener("loadedmetadata", updateStatus);
                window.addEventListener("load", updateStatus);
            </script>

            <div class="status-box">
                <strong>Expected Behavior:</strong>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>‚úì Green badge "‚úì ISweep Active" appears on video</li>
                    <li>‚úì Console shows: <code>[ISweep] Detected 1 video(s)</code></li>
                    <li>‚úì Video plays with captions visible</li>
                    <li>‚úì At ~3-6 seconds: Caption "This contains profanity word" appears</li>
                    <li>‚úì Large "MUTED" text appears in center of video</li>
                    <li>‚úì Video audio mutes</li>
                    <li>‚úì Popup shows "Actions Applied: 1"</li>
                </ul>
            </div>

            <div class="info">
                <strong>üîç Debug Tip:</strong> Open DevTools (F12) ‚Üí Console tab, filter for <code>[ISweep]</code> logs. 
                You should see caption extraction and action logs.
            </div>
        </div>

        <!-- Captions File Info -->
        <div class="test-section">
            <h2>Captions File (captions.vtt)</h2>
            
            <div class="warning">
                <strong>‚ö†Ô∏è Important:</strong> Keep this page self-contained: put <code>isweep_test.html</code> (this file), <code>captions.vtt</code>, and optional <code>test.mp4</code> in the SAME folder (e.g., <code>C:\ISweep_wireframe\isweep-backend\</code> or a dedicated <code>tests</code> subfolder) and open the HTML from there.
            </div>

            <strong>Create this file with the following content:</strong>
            <pre style="background: #f5f5f5; padding: 15px; border-radius: 8px; overflow-x: auto;"><code>WEBVTT

00:00:00.000 --> 00:00:03.000
This is a test video.

00:00:03.000 --> 00:00:06.000
The next word will trigger ISweep: profanity

00:00:06.000 --> 00:00:09.000
Back to normal content.

00:00:09.000 --> 00:00:12.000
This is more normal content.

00:00:12.000 --> 00:00:15.000
Here comes another trigger: profanity again

00:00:15.000 --> 00:00:18.000
End of test video.</code></pre>

            <div class="success">
                <strong>‚úÖ File location:</strong> Put <code>captions.vtt</code> right next to this HTML (example: <code>C:\ISweep_wireframe\tests\captions.vtt</code> if you move the HTML there). If captions seem flaky, also keep a local <code>test.mp4</code> beside it and switch the source to that.
            </div>

            <div class="info">
                <strong>üíª Serve locally to avoid file:// issues:</strong>
                <pre style="background: #f5f5f5; padding: 15px; border-radius: 8px; overflow-x: auto;">cd C:\ISweep_wireframe\isweep-backend
python -m http.server 8080
<-- then open -->
http://127.0.0.1:8080/isweep_test.html
</pre>
                If you must open with <code>file://</code>, enable "Allow access to file URLs" in Chrome extension settings for ISweep.
            </div>

            <div class="info">
                <strong>üìù Captions not showing?</strong> The <code>default</code> flag helps; if they are still hidden, click CC in the player UI.
            </div>
        </div>

        <!-- YouTube Testing -->
        <div class="test-section">
            <h2>Test 2: YouTube Filtering</h2>
            
            <div class="instructions">
                <strong>YouTube Setup Instructions:</strong>
                <ol>
                    <li>Go to <strong>YouTube.com</strong></li>
                    <li>Search for any music video (e.g., "Despacito", "Bohemian Rhapsody")</li>
                    <li>Click on video to play</li>
                    <li>Enable captions by clicking <strong>CC</strong> button (bottom right of video)</li>
                    <li>In ISweep popup, add blocked word: <code>music</code> (or <code>song</code>, <code>beat</code>)</li>
                    <li>Click <strong>Enable ISweep</strong></li>
                    <li>Play the video and watch for filtering</li>
                </ol>
            </div>

            <div class="status-box">
                <strong>Expected Behavior:</strong>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>‚úì Console shows: <code>[ISweep-YT] Initializing YouTube handler</code></li>
                    <li>‚úì Green badge appears on YouTube video</li>
                    <li>‚úì As captions appear with blocked words ‚Üí <strong>MUTED</strong></li>
                    <li>‚úì Large "MUTED" text appears in center</li>
                    <li>‚úì Console shows: <code>[ISweep-YT] Caption: "..."</code></li>
                    <li>‚úì Console shows: <code>[ISweep-YT] Action: mute</code></li>
                    <li>‚úì Stats update: "Actions Applied" increments</li>
                </ul>
            </div>

            <div class="info">
                <strong>üí° Best Videos to Test:</strong>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>Music videos (lots of repeated words)</li>
                    <li>TED Talks (full captions, educational)</li>
                    <li>News clips (BBC, CNN - high caption quality)</li>
                    <li>Any video with auto-generated captions enabled</li>
                </ul>
            </div>

            <div class="warning">
                <strong>‚ö†Ô∏è Note:</strong> YouTube may take 1-2 seconds to show captions after play. 
                If you don't see filtering, check that captions are actually visible on the video.
            </div>
        </div>

        <!-- Debugging -->
        <div class="test-section">
            <h2>üêõ Debugging Checklist</h2>
            
            <div class="status-box">
                <strong>If filtering is NOT working:</strong>
                <ol style="margin-left: 20px; margin-top: 10px;">
                    <li>‚úì Backend running? Test: <code>http://127.0.0.1:8001/docs</code></li>
                    <li>‚úì ISweep enabled? Click icon and check "Active" status</li>
                    <li>‚úì Captions enabled? Right-click video ‚Üí "Show transcript" or CC button</li>
                    <li>‚úì Blocked word matches caption? (case-insensitive)</li>
                    <li>‚úì DevTools console open? F12 ‚Üí Console tab ‚Üí Filter: <code>[ISweep]</code></li>
                </ol>
            </div>

            <div class="info">
                <strong>Console Log Examples You Should See:</strong>
                <pre style="background: #f5f5f5; padding: 15px; border-radius: 8px; font-size: 12px; overflow-x: auto;"><code>[ISweep] Content script loaded
[ISweep] Detected 1 video(s)
[ISweep] Loaded 6 caption cues
[ISweep] Video 0 started playing
[ISweep] Caption: "This contains profanity word"
[ISweep] Action: mute - Blocked word match: 'profanity'</code></pre>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <p>ISweep Test Suite v0.1 | Backend: http://127.0.0.1:8001</p>
        </footer>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const video = document.getElementById("testVideo");
            if (video && video.textTracks) {
                const tracks = video.textTracks;
                for (let i = 0; i < tracks.length; i++) {
                    if (tracks[i].kind === "captions") {
                        tracks[i].mode = "showing"; // ensure captions display
                    }
                }
            }

            // Quick fetch check to confirm captions.vtt is reachable
            fetch("captions.vtt")
                .then((r) => {
                    if (!r.ok) throw new Error("captions.vtt not found");
                    console.log("captions.vtt OK");
                })
                .catch((err) => console.error("captions.vtt load error:", err));

            // Backend reachability hint (no-cors)
            const backendIndicator = document.createElement("div");
            backendIndicator.style.marginTop = "10px";
            backendIndicator.style.fontFamily = "sans-serif";
            backendIndicator.textContent = "Checking backend at http://127.0.0.1:8001/docs ...";
            document.body.insertBefore(backendIndicator, document.body.firstChild);

            fetch("http://127.0.0.1:8001/docs", { mode: "no-cors" })
                .then(() => {
                    backendIndicator.textContent = "Backend reachable: http://127.0.0.1:8001/docs";
                    backendIndicator.style.color = "#0a7a0a";
                })
                .catch(() => {
                    backendIndicator.textContent = "Backend not reachable at http://127.0.0.1:8001/docs";
                    backendIndicator.style.color = "#b91c1c";
                });
        });
    </script>
</body>
</html>